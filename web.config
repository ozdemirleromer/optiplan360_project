<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <handlers>
        <!-- HttpPlatformHandler'ı tüm isteklere yönlendiriyoruz -->
        <add name="httpPlatformHandler" path="*" verb="*" modules="httpPlatformHandler" resourceType="Unspecified" />
    </handlers>
    
    <!-- HttpPlatformHandler'ın FastAPI uygulamasını nasıl çalıştıracağını tanımlar -->
    <httpPlatform processPath="%SystemDrive%\inetpub\wwwroot\optiplan360\backend\.venv\Scripts\python.exe"
                  arguments="-m uvicorn backend.app.main:app --host %HTTP_PLATFORM_ASPNETCORE_HOST% --port %HTTP_PLATFORM_ASPNETCORE_PORT%"
                  stdoutLogEnabled="true"
                  stdoutLogFile=".\logs\python_stdout.log"
                  startupTimeLimit="60"
                  processesPerApplication="1">
      <environmentVariables>
        <!-- Backend uygulamasının kök dizinini PYTHONPATH'e ekliyoruz -->
        <environmentVariable name="PYTHONPATH" value="%SystemDrive%\inetpub\wwwroot\optiplan360\backend" />
        <!-- Diğer ortam değişkenleri (veritabanı bağlantısı vb.) burada tanımlanabilir -->
      </environmentVariables>
    </httpPlatform>

    <!-- Statik Frontend Dosyaları için URL Yeniden Yazma -->
    <rewrite>
        <rules>
            <!-- API isteklerini HttpPlatformHandler'a dokunmadan bırak -->
            <rule name="APIRoute" stopProcessing="true">
                <match url="^api/.*" />
                <action type="None" />
            </rule>
            <!-- Diğer tüm istekleri frontend/index.html'e yönlendir (SPA için) -->
            <rule name="ReactApp" stopProcessing="true">
                <match url=".*" />
                <conditions logicalGrouping="MatchAll">
                    <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                    <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                </conditions>
                <action type="Rewrite" url="/frontend/index.html" />
            </rule>
        </rules>
    </rewrite>

  </system.webServer>
</configuration>
