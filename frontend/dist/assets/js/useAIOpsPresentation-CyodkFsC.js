import{r as t}from"./ui-vendor-X7YeR1nJ.js";import{e,n as o,h as n,C as a}from"./index-BqsYehSy.js";import{i as r,S as i}from"./integrationService-BBjlJOEd.js";import{p as s}from"./paymentService-B1S5G9JA.js";const l={ordersNew:0,ordersProduction:0,ordersReady:0,ordersDelivered:0,ordersTotal:0,paymentCollectionRate:0,paymentOverdue:0,paymentPromises:0,integrationsHealth:"UNKNOWN",integrationsErrors:0,integrationsOutbox:0,integrationsInbox:0,integrationsRunning:0,stockTotal:0,stockActive:0,stockLowCount:0,lastSync:"--"};function u(){const[a,u]=t.useState(!0),[c,d]=t.useState(null),[m,g]=t.useState(l),[k,v]=t.useState([]),[y,p]=t.useState([]),b=t.useRef(45e3),h=t.useRef(null),O=t.useRef(!0),S=t.useCallback(async()=>{var t;u(!0),d(null);const a=await Promise.allSettled([e.getStats(),o.list(),s.getStatistics(),r.getHealth(),r.listSyncJobs(),r.listOutbox(),r.listInbox(),r.listErrors({is_resolved:!1}),n("/stock/stock-cards/summary/stats",{method:"GET"}),n("/stock/stock-cards/low-stock/alert",{method:"GET"})]);function l(t,e){const o=a[t];return"fulfilled"===(null==o?void 0:o.status)?o.value:e}const c=l(0,null),m=l(1,[]),k=l(2,null),y=l(3,null),C=l(4,[]),R=l(5,[]),N=l(6,[]),f=l(7,[]),E=l(8,null),D=l(9,null),x=C.filter(t=>t.status===i.RUNNING).length,T=(null==(t=C[0])?void 0:t.createdAt)??(null==y?void 0:y.lastSync)??"--";g({ordersNew:(null==c?void 0:c.ordersNew)??0,ordersProduction:(null==c?void 0:c.ordersProduction)??0,ordersReady:(null==c?void 0:c.ordersReady)??0,ordersDelivered:(null==c?void 0:c.ordersDelivered)??0,ordersTotal:(null==c?void 0:c.totalOrders)??m.length,paymentCollectionRate:(null==k?void 0:k.collectionRate)??0,paymentOverdue:(null==k?void 0:k.overdueInvoices)??0,paymentPromises:(null==k?void 0:k.pendingPromisesCount)??0,integrationsHealth:(null==y?void 0:y.status)??"UNKNOWN",integrationsErrors:f.length,integrationsOutbox:R.length,integrationsInbox:N.length,integrationsRunning:x,stockTotal:(null==E?void 0:E.totalStockCards)??0,stockActive:(null==E?void 0:E.activeStockCards)??0,stockLowCount:(null==D?void 0:D.count)??0,lastSync:T}),p(m.slice(0,10).map(t=>({id:String(t.id??""),cust:String(t.cust??t.customerName??""),mat:String(t.mat??t.material??""),status:String(t.status??"NEW")}))),v(function(t,e,o){var n;const a=[];return t.length>0&&a.push({title:"Entegrasyon Hatası",detail:(null==(n=t[0])?void 0:n.errorMessage)??"Hata kaydı mevcut",tone:"danger"}),e.length>0&&a.push({title:"Outbox Bekliyor",detail:`${e.length} işlem kuyrukta`,tone:"warning"}),o.length>0&&a.push({title:"Sipariş Akışı",detail:`${o.length} aktif iş`,tone:"info"}),0===a.length&&a.push({title:"Sistem Stabil",detail:"Anormal durum yok",tone:"success"}),a.slice(0,4)}(f,R,m));a.some(t=>"rejected"===t.status)?(d("Bazı kaynaklar yanıt vermedi. Veriler kısıtlı olabilir."),b.current=Math.min(2*b.current,12e4)):b.current=45e3,u(!1),O.current&&(h.current=setTimeout(()=>{S()},b.current))},[]);return t.useEffect(()=>(O.current=!0,b.current=5e3,S(),()=>{O.current=!1,h.current&&clearTimeout(h.current)}),[S]),t.useMemo(()=>({stats:m,activityFeed:k,recentOrders:y,loading:a,partialError:c,reload:S}),[m,k,y,a,c,S])}function c(t){return null==t?"--":new Intl.NumberFormat("tr-TR").format(t)}function d(t){return null==t?"--":`${Math.round(t)}%`}const m={HEALTHY:"success",DEGRADED:"warning",DISCONNECTED:"danger",UNKNOWN:"secondary"};function g(e){const o={HEALTHY:{label:"Sağlam",color:a.success.DEFAULT},DEGRADED:{label:"Dalgalanma",color:a.warning.DEFAULT},DISCONNECTED:{label:"Bağlantı Yok",color:a.danger.DEFAULT},UNKNOWN:{label:"Bilinmiyor",color:a.muted}},n=o[e.integrationsHealth]??o.UNKNOWN,r=m[e.integrationsHealth]??"secondary",i=t.useMemo(()=>[{id:"skill-layer",title:"Beceri Katmanı",value:d(e.paymentCollectionRate),hint:`${c(e.ordersTotal)} aktif operasyon`,toneColor:"#06b6d4",sparkData:[38,41,39,46,52,49,56,58,Math.max(12,Math.round(e.paymentCollectionRate))]},{id:"subagent-main",title:"Alt Ajan",value:c(e.integrationsRunning),hint:`${c(e.integrationsOutbox)} iş kuyrukta`,toneColor:"#8b5cf6",sparkData:[10,14,12,18,15,20,17,21,Math.max(4,e.integrationsRunning+8)]},{id:"orders-throughput",title:"Sipariş Verimi",value:c(e.ordersProduction),hint:`${c(e.ordersReady)} hazır`,toneColor:"#22c55e",sparkData:[11,13,15,16,14,18,20,19,Math.max(6,e.ordersProduction)]},{id:"stock-watch",title:"Stok Takibi",value:c(e.stockLowCount),hint:`${c(e.stockActive)} aktif stok karti`,toneColor:"#f59e0b",sparkData:[8,9,7,10,12,11,9,13,Math.max(3,e.stockLowCount+4)]}],[e.integrationsOutbox,e.integrationsRunning,e.ordersProduction,e.ordersReady,e.ordersTotal,e.paymentCollectionRate,e.stockActive,e.stockLowCount]),s=t.useMemo(()=>[{id:"ORD-9012",name:"OptiPlan360 / Laminat Kapak",station:"İstasyon 1",status:"confirmed",eta:"14 dk"},{id:"ORD-9013",name:"OptiPlan360 / MDF Panel",station:"İstasyon 2",status:"processing",eta:"22 dk"},{id:"ORD-9014",name:"OptiPlan360 / Kutu Profil",station:"İstasyon 3",status:e.integrationsOutbox>0?"queued":"confirmed",eta:e.integrationsOutbox>0?"Beklemede":"12 dk"},{id:"ORD-9015",name:"OptiPlan360 / Özel Seri",station:"Kontrol",status:e.integrationsErrors>0?"blocked":"processing",eta:e.integrationsErrors>0?"Onay bekliyor":"16 dk"}],[e.integrationsErrors,e.integrationsOutbox]),l=t.useMemo(()=>[{label:"Tahsilat",value:d(e.paymentCollectionRate),tone:e.paymentCollectionRate>80?"ok":"warn"},{label:"Senkron Hata",value:c(e.integrationsErrors),tone:e.integrationsErrors>0?"danger":"ok"},{label:"Outbox Baskısı",value:c(e.integrationsOutbox),tone:e.integrationsOutbox>5?"warn":"ok"},{label:"Düşük Stok",value:c(e.stockLowCount),tone:e.stockLowCount>10?"danger":"ok"}],[e.integrationsErrors,e.integrationsOutbox,e.paymentCollectionRate,e.stockLowCount]);return{integrationToneLabel:n.label,badgeVariant:r,metricCards:i,missionOrders:s,riskItems:l}}export{g as a,u};
