import{h as e,k as t,l as i,j as r,B as n,d as s,C as l,T as a,R as o,c as d}from"./index-BqsYehSy.js";import{aj as c,r as u,E as h,f as x,ak as p,X as y,al as g,Y as m}from"./ui-vendor-X7YeR1nJ.js";import"./react-vendor-BTlmOg1k.js";import"./export-jspdf-ClKeqeik.js";import"./state-CRAppeNE.js";import"./export-xlsx-C5xT2hrF.js";const b={async uploadFile(t,i){const r=new FormData;return r.append("file",t),r.append("supplier",i),e("/price-tracking/upload",{method:"POST",body:r})},listJobs:async()=>e("/price-tracking/jobs"),getJobDetail:async t=>e(`/price-tracking/jobs/${t}`),async exportJobs(e){const r=t(),n=await fetch(`${i()}/price-tracking/export`,{method:"POST",headers:{"Content-Type":"application/json",...r?{Authorization:`Bearer ${r}`}:{}},body:JSON.stringify({job_ids:e})});if(!n.ok){const e=await n.text();throw new Error(function(e,t){var i;if(!t)return`HTTP ${e}`;try{const r=JSON.parse(t);return(null==(i=r.error)?void 0:i.message)||r.detail||r.message||`HTTP ${e}`}catch{return t}}(n.status,e))}return n.blob()},async deleteJob(t){await e(`/price-tracking/jobs/${t}`,{method:"DELETE"})}};function j({selectedCount:e,exporting:t,onExport:i}){const s=0===e||t;return r.jsx(n,{variant:"secondary",onClick:i,disabled:s,loading:t,icon:r.jsx(c,{size:14}),title:s?"Excel aktarma icin en az bir is secmelisiniz":"Secili isleri Excel'e aktar",children:t?"Excel hazirlaniyor...":`Excel'e Aktar (${e})`})}function k(e,t){return null===e||Number.isNaN(e)?"-":new Intl.NumberFormat("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e)+(t?` ${t}`:"")}function f({items:e,loading:t}){const[i,n]=u.useState(""),[a,o]=u.useState("ALL"),d=u.useMemo(()=>{const t=new Set(e.map(e=>e.paraBirimi).filter(Boolean));return["ALL",...Array.from(t).sort()]},[e]),c=u.useMemo(()=>{const t=i.trim().toLowerCase();return e.filter(e=>("ALL"===a||e.paraBirimi===a)&&(!t||((e.urunAdi||"").toLowerCase().includes(t)||(e.urunKodu||"").toLowerCase().includes(t)||(e.kategori||"").toLowerCase().includes(t)||(e.marka||"").toLowerCase().includes(t))))},[e,i,a]),h=u.useMemo(()=>t=>e.some(e=>{const i=e[t];return null!=i&&""!==i&&0!==i}),[e]);return r.jsx(s,{title:"Urunler",subtitle:`${c.length} / ${e.length} satir`,actions:r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[r.jsx("input",{value:i,onChange:e=>n(e.target.value),placeholder:"Urun, kod, kategori ara",style:{width:220},"aria-label":"Urun arama"}),r.jsx("select",{value:a,onChange:e=>o(e.target.value),"aria-label":"Para birimi filtre",children:d.map(e=>r.jsx("option",{value:e,children:"ALL"===e?"Tum PB":e},e))})]}),children:r.jsx("div",{style:{overflowX:"auto"},children:r.jsxs("table",{style:{minWidth:980},children:[r.jsx("thead",{children:r.jsxs("tr",{children:[r.jsx("th",{children:"Kod"}),r.jsx("th",{children:"Urun Adi"}),h("boyut")&&r.jsx("th",{children:"Boyut"}),h("renk")&&r.jsx("th",{children:"Renk"}),r.jsx("th",{children:"Birim"}),h("listeFiyati")&&r.jsx("th",{children:"Liste"}),h("iskontoOrani")&&r.jsx("th",{children:"Iskonto"}),h("netFiyat")&&r.jsx("th",{children:"Net"}),h("kdvOrani")&&r.jsx("th",{children:"KDV"}),h("kdvDahilFiyat")&&r.jsx("th",{children:"KDV Dahil"}),h("kategori")&&r.jsx("th",{children:"Kategori"}),h("marka")&&r.jsx("th",{children:"Marka"}),r.jsx("th",{children:"Tedarikci"})]})}),r.jsx("tbody",{children:t?r.jsx("tr",{children:r.jsx("td",{colSpan:12,style:{textAlign:"center",color:l.muted,padding:20},children:"Urunler yukleniyor..."})}):0===c.length?r.jsx("tr",{children:r.jsx("td",{colSpan:12,style:{textAlign:"center",color:l.muted,padding:20},children:"Gosterilecek urun bulunamadi."})}):c.map(e=>r.jsxs("tr",{children:[r.jsx("td",{children:e.urunKodu||"-"}),r.jsx("td",{children:e.urunAdi}),h("boyut")&&r.jsx("td",{children:e.boyut||"-"}),h("renk")&&r.jsx("td",{children:e.renk||"-"}),r.jsx("td",{children:e.birim}),h("listeFiyati")&&r.jsx("td",{children:k(e.listeFiyati,e.paraBirimi)}),h("iskontoOrani")&&r.jsx("td",{children:k(e.iskontoOrani,"%")}),h("netFiyat")&&r.jsx("td",{children:k(e.netFiyat,e.paraBirimi)}),h("kdvOrani")&&r.jsx("td",{children:k(e.kdvOrani,"%")}),h("kdvDahilFiyat")&&r.jsx("td",{children:k(e.kdvDahilFiyat,e.paraBirimi)}),h("kategori")&&r.jsx("td",{children:e.kategori||"-"}),h("marka")&&r.jsx("td",{children:e.marka||"-"}),r.jsx("td",{children:e.tedarikci})]},e.id))})]})})})}function v(e){const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString("tr-TR")}function S({jobs:e,loading:t,activeJobId:i,selectedJobIds:d,deletingJobId:c,onToggleSelect:u,onSelectDetail:p,onDelete:y}){return r.jsxs(s,{title:"Yukleme Isleri",subtitle:`${e.length} kayit`,children:[r.jsx("div",{style:{overflowX:"auto"},children:r.jsxs("table",{style:{minWidth:860},children:[r.jsx("thead",{children:r.jsxs("tr",{children:[r.jsx("th",{style:{width:42},children:"Sec"}),r.jsx("th",{children:"Durum"}),r.jsx("th",{children:"Dosya"}),r.jsx("th",{children:"Tedarikci"}),r.jsx("th",{children:"Satir"}),r.jsx("th",{children:"Olusturma"}),r.jsx("th",{style:{width:200},children:"Islemler"})]})}),r.jsx("tbody",{children:t?r.jsx("tr",{children:r.jsx("td",{colSpan:7,style:{color:l.muted,textAlign:"center",padding:20},children:"Is listesi yukleniyor..."})}):0===e.length?r.jsx("tr",{children:r.jsx("td",{colSpan:7,style:{color:l.muted,textAlign:"center",padding:20},children:"Henuz yuklenmis fiyat listesi yok."})}):e.map(e=>{const t=d.includes(e.id),s=i===e.id,o=function(e){switch(e){case"COMPLETED":return{background:"rgba(16,185,129,0.14)",color:l.success.DEFAULT};case"FAILED":return{background:"rgba(239,68,68,0.14)",color:l.error.DEFAULT};case"PROCESSING":return{background:"rgba(59,130,246,0.14)",color:l.primary.DEFAULT};default:return{background:"rgba(148,163,184,0.18)",color:l.muted}}}(e.status);return r.jsxs("tr",{style:{background:s?"rgba(59,130,246,0.06)":void 0},children:[r.jsx("td",{children:r.jsx("input",{type:"checkbox",checked:t,onChange:()=>u(e.id),"aria-label":`${e.originalFilename??"Dosya"} sec`})}),r.jsx("td",{children:r.jsx("span",{style:{display:"inline-flex",alignItems:"center",borderRadius:999,padding:"2px 8px",fontSize:11,fontWeight:a.fontWeight.semibold,...o},children:e.status})}),r.jsx("td",{style:{maxWidth:220,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},title:e.originalFilename??"-",children:e.originalFilename??"-"}),r.jsx("td",{children:e.supplier}),r.jsx("td",{children:e.rowsExtracted}),r.jsx("td",{children:v(e.createdAt)}),r.jsx("td",{children:r.jsxs("div",{style:{display:"flex",gap:8},children:[r.jsx(n,{size:"sm",variant:"ghost",icon:r.jsx(h,{size:14}),onClick:()=>p(e.id),children:"Detay"}),r.jsx(n,{size:"sm",variant:"danger",icon:r.jsx(x,{size:14}),onClick:()=>y(e.id),disabled:c===e.id,loading:c===e.id,children:"Sil"})]})})]},e.id)})})]})}),r.jsx("div",{style:{marginTop:10,padding:"8px 10px",borderRadius:o.md,background:l.bg.main,border:`1px solid ${l.border}`,fontSize:12,color:l.muted},children:"Not: Export islemi icin birden fazla is secilebilir. Detay tablosu tek secili is icin gosterilir."})]})}function D(e){const t=e.name.toLowerCase();return t.endsWith(".xlsx")||t.endsWith(".xls")||t.endsWith(".pdf")||t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".png")||t.endsWith(".tiff")||t.endsWith(".bmp")}function w({uploading:e,onUpload:t}){const[i,d]=u.useState(""),[c,h]=u.useState(null),[x,m]=u.useState(!1),[b,j]=u.useState(null),k=u.useRef(null),f=()=>{var e;null==(e=k.current)||e.click()};return r.jsx(s,{title:"Fiyat Listesi Yükleme",subtitle:"Excel, PDF veya görsel dosyası",children:r.jsxs("div",{style:{display:"grid",gap:12},children:[r.jsx("input",{type:"file",ref:k,style:{display:"none"},accept:".xlsx,.xls,.pdf,.jpg,.jpeg,.png,.tiff,.bmp",onChange:e=>{var t;const i=(null==(t=e.target.files)?void 0:t[0])??null;i&&D(i)&&(h(i),j(null)),e.target&&(e.target.value="")},"aria-hidden":"true"}),r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"supplier-input",style:{display:"block",fontSize:12,color:l.muted,marginBottom:6,fontWeight:a.fontWeight.semibold},children:["Tedarikçi ",r.jsx("span",{style:{color:l.error.DEFAULT},children:"*"})]}),r.jsx("input",{id:"supplier-input",value:i,onChange:e=>{d(e.target.value),b&&j(null)},placeholder:"Örn: Yıldız MDF, ABC Profil","aria-label":"Tedarikçi adı",style:{width:"100%",padding:"8px 12px",borderRadius:o.md,border:`1px solid ${l.border}`,fontSize:a.fontSize.sm,outline:"none"},disabled:e})]}),r.jsx("div",{role:"button",tabIndex:0,onClick:f,onDragOver:e=>{e.preventDefault(),m(!0)},onDragLeave:e=>{e.preventDefault(),m(!1)},onDrop:e=>{var t;e.preventDefault(),m(!1);const i=(null==(t=e.dataTransfer.files)?void 0:t[0])??null;i&&D(i)&&(h(i),j(null))},onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),f())},style:{border:`1px dashed ${x?l.primary.DEFAULT:l.border}`,borderRadius:o.lg,minHeight:120,display:"grid",placeItems:"center",textAlign:"center",padding:16,background:x?"rgba(59,130,246,0.08)":l.bg.main,cursor:e?"not-allowed":"pointer",opacity:e?.6:1,transition:"all 0.2s ease"},"aria-label":"Dosya yüklemek için tıklayın veya sürükleyip bırakın",children:r.jsxs("div",{children:[r.jsx(p,{size:24,color:l.primary.DEFAULT,style:{margin:"0 auto"}}),r.jsx("div",{style:{marginTop:8,fontSize:13,color:l.text,fontWeight:500},children:"Dosyayı buraya bırakın veya seçmek için tıklayın"}),r.jsx("div",{style:{marginTop:4,fontSize:11,color:l.muted},children:"Desteklenen: XLSX, XLS, PDF, JPG, PNG"})]})}),c&&r.jsxs("div",{style:{border:`1px solid ${l.border}`,borderRadius:o.md,padding:"8px 10px",display:"flex",alignItems:"center",justifyContent:"space-between",gap:8,background:l.bg.main},children:[r.jsxs("div",{style:{fontSize:12,color:l.text,overflow:"hidden",textOverflow:"ellipsis",display:"flex",alignItems:"center",gap:6},children:[r.jsx(p,{size:14,color:l.muted}),r.jsx("span",{children:c.name}),r.jsxs("span",{style:{color:l.muted},children:["(",Math.max(1,Math.round(c.size/1024))," KB)"]})]}),r.jsx("button",{type:"button",onClick:e=>{e.stopPropagation(),h(null),k.current&&(k.current.value="")},"aria-label":"Seçili dosyayı kaldır",style:{width:24,height:24,borderRadius:6,border:"none",background:"transparent",color:l.muted,display:"grid",placeItems:"center",cursor:"pointer"},children:r.jsx(y,{size:14})})]}),b&&r.jsx("div",{style:{fontSize:13,color:l.error.DEFAULT,fontWeight:500},children:b}),r.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:r.jsx(n,{variant:"primary",icon:r.jsx(g,{size:14}),onClick:async()=>{if(c){if(!i.trim()){j("Lütfen tedarikçi adını giriniz.");const e=document.getElementById("supplier-input");return void(e&&e.focus())}j(null);try{await t(c,i.trim()),d(""),h(null)}catch(e){}}else j("Lütfen bir dosya seçiniz.")},disabled:e,loading:e,children:e?"Yükleniyor...":"Yükle ve İzle"})})]})})}function E(){const[e,t]=u.useState([]),[i,s]=u.useState([]),[a,c]=u.useState(null),[h,x]=u.useState(null),[p,y]=u.useState(!1),[g,k]=u.useState(!1),[v,D]=u.useState(!1),[E,L]=u.useState(!1),[F,T]=u.useState(null),[z,C]=u.useState(null),A=u.useMemo(()=>e.some(e=>"PENDING"===e.status||"PROCESSING"===e.status),[e]),I=u.useCallback(async()=>{y(!0);try{const e=await b.listJobs();t(e),s(t=>t.filter(t=>e.some(e=>e.id===t))),a&&!e.some(e=>e.id===a)&&(c(null),x(null))}catch(e){C({type:"error",text:e instanceof Error?e.message:"Is listesi yuklenemedi"})}finally{y(!1)}},[a]),O=u.useCallback(async e=>{k(!0),c(e);try{const t=await b.getJobDetail(e);x(t)}catch(t){C({type:"error",text:t instanceof Error?t.message:"Is detayi yuklenemedi"})}finally{k(!1)}},[]);u.useEffect(()=>{I()},[I]),u.useEffect(()=>{if(!A)return;const e=window.setInterval(()=>{I(),a&&O(a)},5e3);return()=>window.clearInterval(e)},[a,A,O,I]);const U=async()=>{if(0!==i.length){L(!0),C(null);try{const e=await b.exportJobs(i);!function(e,t){const i=URL.createObjectURL(e),r=document.createElement("a");r.href=i,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}(e,`Fiyat_Listesi_${(new Date).toISOString().slice(0,10)}.xlsx`),C({type:"success",text:"Excel dosyasi hazirlandi."})}catch(e){C({type:"error",text:e instanceof Error?e.message:"Export basarisiz"})}finally{L(!1)}}},$="success"===(null==z?void 0:z.type)?{background:"rgba(16,185,129,0.12)",border:"rgba(16,185,129,0.35)",color:l.success.DEFAULT}:"error"===(null==z?void 0:z.type)?{background:"rgba(239,68,68,0.12)",border:"rgba(239,68,68,0.35)",color:l.error.DEFAULT}:{background:"rgba(59,130,246,0.12)",border:"rgba(59,130,246,0.35)",color:l.primary.DEFAULT};return r.jsxs("div",{className:"electric-page",children:[r.jsxs(d,{title:"Fiyat Takip",subtitle:"Dosya yukleme, AI tabanli satir cikarma ve Excel export",breadcrumbs:["Orkestrasyon","Fiyat Takip"],children:[r.jsx(n,{variant:"ghost",icon:r.jsx(m,{size:14}),onClick:()=>{I()},disabled:p,children:"Yenile"}),r.jsx(j,{selectedCount:i.length,exporting:E,onExport:()=>{U()}})]}),r.jsxs("div",{className:"app-page-container",style:{display:"grid",gap:16,alignContent:"start"},children:[z?r.jsx("div",{role:"error"===z.type?"alert":"status",style:{border:`1px solid ${$.border}`,background:$.background,color:$.color,borderRadius:o.md,padding:"10px 12px",fontSize:13},children:z.text}):null,r.jsx(w,{uploading:v,onUpload:async(e,t)=>{D(!0),C(null);try{const i=await b.uploadFile(e,t);await I(),C({type:"success",text:`Yukleme alindi: ${i.originalFilename??i.id}`}),c(i.id),s(e=>e.includes(i.id)?e:[i.id,...e]),await O(i.id)}catch(i){C({type:"error",text:i instanceof Error?i.message:"Yukleme basarisiz"})}finally{D(!1)}}}),r.jsx(S,{jobs:e,loading:p,activeJobId:a,selectedJobIds:i,deletingJobId:F,onToggleSelect:e=>{s(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},onSelectDetail:e=>{O(e)},onDelete:e=>{(async e=>{if(window.confirm("Secili yukleme isi silinsin mi?")){T(e),C(null);try{await b.deleteJob(e),a===e&&(c(null),x(null)),await I(),C({type:"success",text:"Yukleme isi silindi."})}catch(t){C({type:"error",text:t instanceof Error?t.message:"Silme islemi basarisiz"})}finally{T(null)}}})(e)}}),r.jsx(f,{items:(null==h?void 0:h.items)??[],loading:g})]})]})}export{E as default};
