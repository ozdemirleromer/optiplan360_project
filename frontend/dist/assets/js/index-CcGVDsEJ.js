import{o as e,n as t,j as i,c as r,B as s,R as n,C as a,O as l,M as o,q as d,r as c}from"./index-BqsYehSy.js";import{r as p,V as u,Y as x,A as m,ad as y,S as g,q as f,ar as h,i as b,e as j,m as v,ac as z,T as S,Q as k,j as C,aj as w,as as T,a6 as D}from"./ui-vendor-X7YeR1nJ.js";import"./react-vendor-BTlmOg1k.js";import"./export-jspdf-ClKeqeik.js";import"./state-CRAppeNE.js";import"./export-xlsx-C5xT2hrF.js";const R=45e3;function E({state:e}){const t=c[e]??e,r=l[e]??"#6b7280";return i.jsx("span",{style:{display:"inline-flex",alignItems:"center",padding:"3px 10px",borderRadius:n.full,fontSize:11,fontWeight:600,backgroundColor:r+"22",color:r,border:`1px solid ${r}44`,whiteSpace:"nowrap"},children:t})}function A(e){if(!e)return"-";const t=Date.now()-new Date(e).getTime(),i=Math.floor(t/6e4);if(i<1)return"az once";if(i<60)return`${i} dk once`;const r=Math.floor(i/60);return r<24?`${r} saat once`:new Date(e).toLocaleDateString("tr-TR")}function O({job:t,onApprove:r,onRetry:o,onCancel:d,loading:c}){var u;const[x,m]=p.useState(!1),[y,g]=p.useState(null),[f,h]=p.useState(!1),[j,v]=p.useState(!1),z=c===t.id;p.useEffect(()=>{if(!x)return;["XML_READY","DELIVERED","DONE","OPTI_DONE"].includes(t.state)&&(h(!0),e.getReceipt(t.id).then(g).catch(()=>g(null)).finally(()=>h(!1)))},[x,t.id,t.state]);const S=!["DONE","FAILED"].includes(t.state),R="XML_READY"===t.state;return i.jsxs("div",{style:{border:`1px solid ${a.border}`,borderRadius:n.md,borderLeft:`4px solid ${l[t.state]??a.muted}`,backgroundColor:x?a.bg.elevated:a.surface,transition:"background 0.15s",marginBottom:8},children:[i.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"12px 16px",gap:12,cursor:"pointer",flexWrap:"wrap"},onClick:()=>m(e=>!e),children:[x?i.jsx(C,{size:14,color:a.muted}):i.jsx(b,{size:14,color:a.muted}),i.jsxs("div",{style:{minWidth:80},children:[i.jsxs("div",{style:{fontSize:15,fontWeight:700,color:a.primary.DEFAULT},children:["#",t.orderId]}),i.jsx("div",{style:{fontSize:10,color:a.muted,fontFamily:"monospace"},children:t.id.substring(0,8)})]}),i.jsx(E,{state:t.state}),t.errorMessage&&i.jsx("div",{style:{fontSize:11,color:"#ef4444",maxWidth:250,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1},title:t.errorMessage,children:t.errorMessage.substring(0,80)}),i.jsx("div",{style:{fontSize:11,color:a.muted,marginLeft:"auto",whiteSpace:"nowrap"},children:A(t.updatedAt??t.createdAt)}),i.jsxs("div",{style:{display:"flex",gap:6},onClick:e=>e.stopPropagation(),children:[R&&i.jsxs("a",{href:e.getXmlDownloadUrl(t.id),target:"_blank",rel:"noreferrer",title:"XML Indir",style:{display:"inline-flex",alignItems:"center",gap:4,padding:"5px 10px",borderRadius:n.md,fontSize:11,fontWeight:600,background:a.primary.DEFAULT,color:"#fff",textDecoration:"none"},children:[i.jsx(w,{size:12})," XML"]}),"HOLD"===t.state&&i.jsx(s,{size:"sm",variant:"primary",onClick:()=>r(t.id),disabled:z,children:"Onayla"}),("FAILED"===t.state||"HOLD"===t.state)&&i.jsxs(s,{size:"sm",variant:"secondary",onClick:()=>o(t.id),disabled:z,children:[i.jsx(T,{size:12,style:{marginRight:3}})," Tekrar"]}),S&&i.jsx(s,{size:"sm",variant:"danger",onClick:()=>d(t.id),disabled:z,children:i.jsx(k,{size:12})})]})]}),x&&i.jsxs("div",{style:{padding:"0 16px 16px",borderTop:`1px solid ${a.border}`},children:[i.jsxs("div",{style:{display:"flex",gap:24,padding:"12px 0",flexWrap:"wrap",fontSize:12},children:[i.jsxs("div",{children:[i.jsx("span",{style:{color:a.muted},children:"Olusturulma: "}),i.jsx("span",{style:{color:a.text},children:t.createdAt?new Date(t.createdAt).toLocaleString("tr-TR"):"-"})]}),i.jsxs("div",{children:[i.jsx("span",{style:{color:a.muted},children:"Son Guncelleme: "}),i.jsx("span",{style:{color:a.text},children:t.updatedAt?new Date(t.updatedAt).toLocaleString("tr-TR"):"-"})]}),t.retryCount>0&&i.jsxs("div",{children:[i.jsx("span",{style:{color:a.muted},children:"Tekrar Deneme: "}),i.jsxs("span",{style:{color:"#f59e0b",fontWeight:600},children:[t.retryCount,"x"]})]})]}),t.errorMessage&&i.jsxs("div",{style:{marginBottom:12,padding:"10px 12px",backgroundColor:"#ef444418",borderRadius:n.md,border:"1px solid #ef444433",color:"#ef4444",fontSize:12},children:[i.jsxs("strong",{children:[t.errorCode,": "]}),t.errorMessage]}),f&&i.jsx("div",{style:{fontSize:12,color:a.muted,padding:"8px 0"},children:"Siparis fisi yukleniyor..."}),y&&i.jsxs("div",{style:{marginBottom:12},children:[y.xmlParse&&!y.xmlParse.error&&void 0!==y.xmlParse.mqBoards&&i.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(120px, 1fr))",gap:8,padding:12,backgroundColor:a.bg.elevated,borderRadius:n.md,border:`1px solid ${a.border}`,marginBottom:10},children:[{label:"Plaka m²",value:null==(u=y.xmlParse.mqBoards)?void 0:u.toFixed(2)},{label:"Plaka Adedi",value:String(y.plakaAdedi)},{label:"Bant (m)",value:y.bantMetre.toFixed(2)},{label:"Desen",value:null!=y.xmlParse.patterns?String(y.xmlParse.patterns):"-"},{label:"Maliyet",value:null!=y.xmlParse.jobCost?`${y.xmlParse.jobCost.toFixed(2)} TL`:"-"}].map(({label:e,value:t})=>i.jsxs("div",{children:[i.jsx("div",{style:{fontSize:10,color:a.muted},children:e}),i.jsx("div",{style:{fontSize:14,fontWeight:700,color:a.text},children:t})]},e))}),y.invoice?i.jsxs("div",{style:{padding:12,backgroundColor:"#22c55e11",borderRadius:n.md,border:"1px solid #22c55e33",display:"flex",gap:20,flexWrap:"wrap",alignItems:"center"},children:[i.jsxs("div",{children:[i.jsx("div",{style:{fontSize:10,color:a.muted},children:"Fatura"}),i.jsx("div",{style:{fontSize:13,fontWeight:600},children:y.invoice.number})]}),i.jsxs("div",{children:[i.jsx("div",{style:{fontSize:10,color:a.muted},children:"Toplam"}),i.jsxs("div",{style:{fontSize:16,fontWeight:700,color:"#22c55e"},children:[y.invoice.totalAmount.toLocaleString("tr-TR",{minimumFractionDigits:2})," TL"]})]})]}):i.jsxs("div",{style:{padding:10,backgroundColor:a.bg.elevated,borderRadius:n.md,border:`1px solid ${a.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[i.jsx("span",{style:{fontSize:12,color:a.muted},children:"Siparis fisi henuz olusturulmamis."}),i.jsxs(s,{size:"sm",variant:"primary",onClick:async function(){v(!0);try{await e.createReceipt(t.id);const i=await e.getReceipt(t.id);g(i)}catch{}finally{v(!1)}},disabled:j,children:[i.jsx(D,{size:12,style:{marginRight:4}}),j?"...":"Fis Olustur"]})]})]}),t.events.length>0&&i.jsxs("div",{children:[i.jsx("div",{style:{fontSize:11,fontWeight:600,color:a.muted,marginBottom:6},children:"Son Olaylar"}),[...t.events].sort((e,t)=>(t.createdAt??"").localeCompare(e.createdAt??"")).slice(0,5).map(e=>i.jsxs("div",{style:{display:"flex",gap:8,padding:"4px 0",fontSize:11},children:[i.jsx("span",{style:{color:a.muted,minWidth:100},children:e.createdAt?new Date(e.createdAt).toLocaleTimeString("tr-TR"):"-"}),i.jsx("span",{style:{color:a.text},children:e.message??e.eventType})]},e.id))]})]})]})}function I(){const[c,C]=p.useState([]),[w,T]=p.useState(0),[D,E]=p.useState(!1),[A,I]=p.useState(null),[L,W]=p.useState(null),[N,B]=p.useState(""),[F,$]=p.useState(""),[P,M]=p.useState(0),[U,Y]=p.useState(null),[_,J]=p.useState(!1),[X,H]=p.useState([]),[V,q]=p.useState(!1),[G,K]=p.useState(new Set),[Q,Z]=p.useState(""),ee=p.useRef(!0),te=p.useRef(null),ie=p.useRef(R),{confirm:re}=d(),se=Math.ceil(w/25),ne=p.useCallback(async(t=0)=>{if(!ee.current)return;E(!0);let i=!1;try{const i=F.trim()?parseInt(F.trim(),10):void 0,r=await e.listJobs({limit:25,offset:25*t,state:N||void 0,orderId:i&&!isNaN(i)?i:void 0});ee.current&&(C(r.jobs),T(r.total))}catch{i=!0}finally{ee.current&&E(!1),ie.current=i?Math.min(2*ie.current,12e4):R,ee.current&&(te.current=setTimeout(()=>{ne(t)},ie.current))}},[N,F]),ae=p.useCallback(async()=>{try{const t=await e.getWorkerStatus();ee.current&&Y(t)}catch{}},[]);p.useEffect(()=>(ee.current=!0,M(0),ne(0),ae(),()=>{ee.current=!1,te.current&&clearTimeout(te.current)}),[ne,ae]),p.useEffect(()=>{_&&(q(!0),t.list().then(e=>{const t=e.filter(e=>["NEW","IN_PRODUCTION","APPROVED"].includes(e.status));H(t)}).catch(()=>H([])).finally(()=>q(!1)))},[_]);const le=Q.trim()?X.filter(e=>e.cust.toLowerCase().includes(Q.toLowerCase())||e.phone.includes(Q)||String(e.id).includes(Q)||(e.orderNo??"").toString().includes(Q)):X,oe=(e,t)=>{W({type:e,text:t}),setTimeout(()=>W(null),3500)},de=e=>{te.current&&clearTimeout(te.current),M(e),ne(e)},ce=async t=>{I(t);try{const i=await e.approveJob(t);C(e=>e.map(e=>e.id===t?i:e)),oe("success","Job onaylandi.")}catch(i){oe("error",i instanceof Error?i.message:"Onaylama basarisiz.")}finally{I(null)}},pe=async t=>{I(t);try{const i=await e.retryJob(t);C(e=>e.map(e=>e.id===t?i:e)),oe("success","Job yeniden baslatildi.")}catch(i){oe("error",i instanceof Error?i.message:"Retry basarisiz.")}finally{I(null)}},ue=async t=>{if(await re({title:"Job Iptal Et",message:"Bu job'i iptal etmek istediginizden emin misiniz?",type:"danger",confirmText:"Iptal Et",cancelText:"Vazgec"})){I(t);try{const i=await e.cancelJob(t);C(e=>e.map(e=>e.id===t?i:e)),oe("success","Job iptal edildi.")}catch(i){oe("error",i instanceof Error?i.message:"Iptal basarisiz.")}finally{I(null)}}},xe=[{key:"OPTI_RUNNING",icon:i.jsx(v,{size:14}),label:"Calisiyor"},{key:"OPTI_DONE",icon:i.jsx(z,{size:14}),label:"Opt. Bekliyor"},{key:"XML_READY",icon:i.jsx(f,{size:14}),label:"XML Hazir"},{key:"DONE",icon:i.jsx(j,{size:14}),label:"Tamamlandi"},{key:"HOLD",icon:i.jsx(S,{size:14}),label:"Beklemede"},{key:"FAILED",icon:i.jsx(k,{size:14}),label:"Basarisiz"}],me=c.reduce((e,t)=>(e[t.state]=(e[t.state]??0)+1,e),{});return i.jsxs("div",{className:"electric-page",children:[i.jsx(r,{title:"OptiPlanning Isler",subtitle:`${w} is toplam`,breadcrumbs:["Orkestrasyon","OptiPlanning"],children:i.jsxs("div",{style:{display:"flex",gap:8},children:[i.jsxs(s,{variant:"primary",size:"sm",onClick:()=>J(!0),children:[i.jsx(u,{size:14,style:{marginRight:6}}),"Yeni Optimizasyon"]}),i.jsx(s,{variant:"secondary",size:"sm",onClick:()=>{te.current&&clearTimeout(te.current),ne(P),ae()},disabled:D,children:i.jsx(x,{size:14})})]})}),i.jsxs("div",{className:"app-page-container",children:[L&&i.jsx("div",{style:{marginBottom:16,padding:"10px 16px",borderRadius:n.md,backgroundColor:"success"===L.type?"#22c55e22":"#ef444422",color:"success"===L.type?"#22c55e":"#ef4444",border:"1px solid "+("success"===L.type?"#22c55e44":"#ef444444"),fontSize:13},children:L.text}),U&&i.jsxs("div",{style:{marginBottom:16,padding:"8px 16px",borderRadius:n.md,backgroundColor:U.circuitOpen?"#ef444415":a.bg.elevated,border:`1px solid ${U.circuitOpen?"#ef444444":a.border}`,display:"flex",alignItems:"center",gap:16,flexWrap:"wrap",fontSize:12},children:[i.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[i.jsx(m,{size:14,color:U.circuitOpen?"#ef4444":"#22c55e"}),i.jsxs("span",{style:{fontWeight:600,color:U.circuitOpen?"#ef4444":"#22c55e"},children:["Worker: ",U.circuitOpen?"DEVRE DISI":"AKTIF"]})]}),i.jsxs("span",{style:{color:a.muted},children:["Kuyruk: ",i.jsx("strong",{style:{color:a.text},children:U.queueCount})]}),i.jsxs("span",{style:{color:a.muted},children:["Calisiyor: ",i.jsx("strong",{style:{color:a.text},children:U.runningCount})]}),U.circuitOpen&&i.jsxs(s,{size:"sm",variant:"danger",onClick:async()=>{try{await e.resetWorkerCircuitBreaker(),await ae(),oe("success","Circuit breaker sifirlandi.")}catch{oe("error","Sifirlama basarisiz.")}},children:[i.jsx(y,{size:12,style:{marginRight:4}})," Sifirla"]})]}),i.jsxs("div",{style:{display:"flex",gap:6,marginBottom:16,flexWrap:"wrap"},children:[i.jsxs("button",{onClick:()=>B(""),style:{display:"flex",alignItems:"center",gap:5,padding:"6px 12px",borderRadius:n.md,fontSize:12,fontWeight:""===N?700:400,border:`1px solid ${""===N?a.primary.DEFAULT+"66":a.border}`,backgroundColor:""===N?a.primary.DEFAULT+"15":"transparent",color:""===N?a.primary.DEFAULT:a.muted,cursor:"pointer"},children:["Tumunu (",w,")"]}),xe.map(({key:e,icon:t,label:r})=>{const s=me[e]??0,o=N===e,d=l[e];return i.jsxs("button",{onClick:()=>B(o?"":e),style:{display:"flex",alignItems:"center",gap:5,padding:"6px 12px",borderRadius:n.md,fontSize:12,fontWeight:o?700:400,border:`1px solid ${o?d+"66":a.border}`,backgroundColor:o?d+"15":"transparent",color:o?d:a.muted,cursor:"pointer"},children:[t,i.jsx("strong",{style:{color:d},children:s}),i.jsx("span",{children:r})]},e)})]}),i.jsxs("div",{style:{position:"relative",maxWidth:250,marginBottom:12},children:[i.jsx(g,{size:14,style:{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",color:a.muted,pointerEvents:"none"}}),i.jsx("input",{type:"text",placeholder:"Siparis No ile ara...",value:F,onChange:e=>$(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(te.current&&clearTimeout(te.current),M(0),ne(0))},style:{width:"100%",padding:"8px 10px 8px 30px",borderRadius:n.md,border:`1px solid ${a.border}`,background:a.bg.elevated,color:a.text,fontSize:12,outline:"none"}})]}),D&&0===c.length?i.jsxs("div",{style:{padding:40,textAlign:"center",color:a.muted},children:[i.jsx(x,{size:24,style:{marginBottom:8,opacity:.4}}),i.jsx("div",{children:"Yukleniyor..."})]}):0===c.length?i.jsxs("div",{style:{padding:40,textAlign:"center",color:a.muted},children:[i.jsx(f,{size:32,style:{marginBottom:8,opacity:.3}}),i.jsx("div",{style:{fontSize:14},children:"Henuz is yok"}),i.jsx("div",{style:{fontSize:12,marginTop:4},children:'"Yeni Optimizasyon" butonuyla siparis secerek baslatabilirsiniz.'})]}):i.jsx("div",{children:c.map(e=>i.jsx(O,{job:e,onApprove:ce,onRetry:pe,onCancel:ue,loading:A},e.id))}),se>1&&i.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:16,padding:"10px 16px",backgroundColor:a.bg.elevated,borderRadius:n.md,border:`1px solid ${a.border}`},children:[i.jsxs("div",{style:{fontSize:12,color:a.muted},children:["Sayfa ",P+1," / ",se]}),i.jsxs("div",{style:{display:"flex",gap:6},children:[i.jsx(s,{size:"sm",variant:"ghost",onClick:()=>de(P-1),disabled:0===P||D,children:i.jsx(h,{size:14})}),i.jsx(s,{size:"sm",variant:"ghost",onClick:()=>de(P+1),disabled:P>=se-1||D,children:i.jsx(b,{size:14})})]})]}),i.jsxs("div",{style:{marginTop:8,fontSize:11,color:a.muted,textAlign:"right"},children:[45,"s'de otomatik guncellenir",D&&" — Guncelleniyor..."]})]}),i.jsx(o,{open:_,onClose:()=>{J(!1),K(new Set),Z("")},title:"Yeni Optimizasyon Baslat",subtitle:"Optimizasyona gondermek istediginiz siparisleri secin",id:"create-job-modal",children:i.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[i.jsxs("div",{style:{position:"relative"},children:[i.jsx(g,{size:14,style:{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",color:a.muted,pointerEvents:"none"}}),i.jsx("input",{type:"text",placeholder:"Musteri, telefon veya siparis no ile ara...",value:Q,onChange:e=>Z(e.target.value),style:{width:"100%",padding:"8px 10px 8px 32px",borderRadius:n.md,border:`1px solid ${a.border}`,background:a.bg.elevated,color:a.text,fontSize:13,outline:"none"}})]}),G.size>0&&i.jsxs("div",{style:{padding:"8px 12px",borderRadius:n.md,backgroundColor:a.primary.DEFAULT+"15",border:`1px solid ${a.primary.DEFAULT}44`,fontSize:12,color:a.primary.DEFAULT,fontWeight:600},children:[G.size," siparis secildi"]}),i.jsx("div",{style:{maxHeight:350,overflowY:"auto",border:`1px solid ${a.border}`,borderRadius:n.md},children:V?i.jsx("div",{style:{padding:20,textAlign:"center",color:a.muted,fontSize:13},children:"Siparisler yukleniyor..."}):0===le.length?i.jsx("div",{style:{padding:20,textAlign:"center",color:a.muted,fontSize:13},children:0===X.length?"Optimizasyona uygun siparis bulunamadi (NEW / IN_PRODUCTION durumunda siparis gerekli)":"Aramayla eslesen siparis bulunamadi"}):le.map(e=>{const t=G.has(e.id);return i.jsxs("div",{onClick:()=>{return t=e.id,void K(e=>{const i=new Set(e);return i.has(t)?i.delete(t):i.add(t),i});var t},style:{display:"flex",alignItems:"center",gap:12,padding:"10px 14px",borderBottom:`1px solid ${a.border}`,cursor:"pointer",backgroundColor:t?a.primary.DEFAULT+"12":"transparent",transition:"background 0.1s"},children:[i.jsx("div",{style:{width:18,height:18,borderRadius:4,flexShrink:0,border:`2px solid ${t?a.primary.DEFAULT:a.border}`,backgroundColor:t?a.primary.DEFAULT:"transparent",display:"flex",alignItems:"center",justifyContent:"center"},children:t&&i.jsx(j,{size:12,color:"#fff"})}),i.jsxs("div",{style:{flex:1},children:[i.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[i.jsx("span",{style:{fontSize:13,fontWeight:600,color:a.text},children:e.orderNo||`#${e.id}`}),i.jsx("span",{style:{fontSize:12,color:a.muted},children:e.cust})]}),i.jsxs("div",{style:{fontSize:11,color:a.muted},children:[e.mat||"-"," | ",e.thick,"mm | ",e.plate||"-"," | ","number"==typeof e.parts?e.parts:0," parca"]})]}),i.jsx("span",{style:{fontSize:10,padding:"2px 8px",borderRadius:n.full,backgroundColor:"NEW"===e.status?"#0ea5e922":"#f59e0b22",color:"NEW"===e.status?"#0ea5e9":"#f59e0b",fontWeight:600},children:e.status})]},e.id)})}),i.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:[i.jsx(s,{variant:"ghost",onClick:()=>{J(!1),K(new Set)},children:"Vazgec"}),i.jsx(s,{variant:"primary",onClick:async()=>{if(0!==G.size)try{I("new");const t=Array.from(G).map(e=>Number(e));await e.runOptimization(t),oe("success",`${t.length} siparis optimizasyona gonderildi.`),J(!1),K(new Set),Z(""),te.current&&clearTimeout(te.current),ne(0)}catch(t){oe("error",t instanceof Error?t.message:"Optimizasyon tetiklenemedi")}finally{I(null)}},disabled:0===G.size||"new"===A,children:"new"===A?"Gonderiliyor...":(G.size>0?G.size+" Siparis ":"")+"Optimizasyona Gonder"})]})]})})]})}export{I as default};
